IFRS - Instituto Federal Rio Grande do Sul

Banco de Dados: Oracle PL/SQL - Turma 2025B

MODULO 2

<pre>
2.1 Procedure
Uma procedure é um bloco PL/SQL que possui um nome e uma vez  criada é compilada e fica armazenado no Banco de Dados. Como a procedure fica armazenada no banco de dados, ela pode ser chamada de um programa de aplicação escrito em Python, Java, PHP ou outra linguagem.

A procedure é criada com os comandos CREATE PROCEDURE ou CREATE OR REPLACE PROCEDURE. 

Uma procedure pode ter um ou mais comandos DML - [Departamento Médico-Legal],[Depósito de Material de Limpeza] Data Manipulation Language (insert, update e delete) e um ou mais comandos SELECT.

A utilização de procedures possui os seguintes benefícios:

Segurança
Maior desempenho
Manutenção                                                                                                                                                                                                                                  
Comando para criar uma procedure

CREATE OR REPLACE PROCEDURE <nome da procedure> [(<variavel> IN <tipo> , <variavel> OUT <tipo>,...., <variavel> IN OUT <tipo>)] IS
[ <variavel> <tipo>,
    ......
   <variavel> <tipo>
]
BEGIN
     <comandos PL_SQL>
END;

﻿Atenção: Pode-se utilizar commit e rollback dentro das procedures/functions.


Importante: A procedure pode ser criada apenas com o create procedure. A utilização do comando create or replace significa que se procedure não existe ela será criada e se já existir é substituída. Em ambiente de desenvolvimento pode-se utilizar o create or replace mas em ambiente de produção recomenda-se utilizar create procedure. 



Comando para eliminar uma procedure
DROP PROCEDURE <nome>;

Exemplo: Criar uma procedure que insere 10 registros na tabela funcionário.

CREATE OR REPLACE PROCEDURE carga IS
  v_i NUMBER(6);
  v_sal NUMBER(6) := 1000;
BEGIN
 FOR v_i IN 1..10 LOOP
 Insert into funcionario(id_funcionario, nome_funcionario,salario, id_departamento, id_cargo) 
    values(sfuncionario.nextval,'Pedro'||v_i,v_sal,100,300);
  v_sal := v_sal + 100;
END LOOP;
 END;

Explicação:

O trecho de código acima é semelhante ao apresentado no módulo anterior quando criamos um bloco PL/SQL anônimo para inserir 10 linhas na tabela funcionário. A diferença está no CREATE OR REPLACE PROCEDURE CARGA que dá um nome ao bloco PL/SQL neste caso, carga. Sendo assim, a procedure será compilada e armazenada no banco de dados e poderá ser chamado posteriormente.

Como chamar a procedure carga: 

1. Utilizando o Execute
 EXECUTE carga;

2. Utilizando o Exec
        EXEC carga;

3. Utilizando o Call
 Call carga();

4. Utilizando um bloco PL/SQL anônimo
Begin
  Carga;
End;
</pre>

<pre>
  2.1.1 Parâmetros
Parâmetros
Uma procure pode ter um ou mais parâmetros Os parâmetros podem ser:

IN – parâmetro de entrada (é o padrão). Significa que o valor é passado ao parâmetro e não pode ser alterado.

OUT – parâmetro de saída.  Significa que um valor pode ser atribuído ao parâmetro na procedure e retornado ao programa principal.

IN OUT -  parâmetro de entrada e saída. Significa que um valor pode ser passado e retornado pelo parâmetro.

Observação: Se o IN e OUT não forem utilizados na declaração do parâmetro indica que ele é um parâmetro de entrada (IN).
Exemplo: Alterar a procedure carga para receber um parâmetro de entrada que é o número de linhas que devem ser inseridas na tabela funcionario.

CREATE OR REPLACE PROCEDURE carga(v_linhas IN NUMBER) IS
  v_i NUMBER(6);
  v_sal NUMBER(6) := 1000;
BEGIN
 FOR v_i IN 1..v_linhas LOOP
     insert into funcionario(id_funcionario, nome_funcionario,salario, id_departamento, id_cargo) 
      values(sfuncionario.nextval,'Pedro'||v_i,v_sal,100,300);
     v_sal := v_sal + 100;
 END LOOP;
END;

O parâmetro v_linhas do tipo NUMBER é utilizado no comando FOR v_i IN 1..v_linhas para determinar o número de repetições no laço de repetição FOR e consequentemente o número de linhas que serão inseridas na tabela funcionário.

Na chamada do procedimento o valor 4 é passado para o parâmetro v_linhas. Isso indica que serão inseridas 4 linhas na tabela funcionario.

--Chamada da procedure

EXEC carga(4);
</pre>

<pre>
2.1.2 Parâmetro do tipo OUT
O parâmetro do tipo OUT permite que um valor seja atribuído ao parâmetro dentro da PROCEDURE e retorne ao bloco que chamou a PROCEDURE.

Exemplo: Procedure que retorna em um parâmetro de saída o número de linhas da tabela funcionario.

CREATE OR REPLACE PROCEDURE conta_funcionarios(p_total OUT NUMBER) IS
BEGIN
  SELECT count(*)
  INTO p_total
  FROM funcionario;
END;

Explicando o código:

O parâmetro p_total é utilizado na cláusula INTO e recebe o número de linhas da tabela funcionário. O select utiliza a função de agregação count para contar o número de linhas da tabela funcionário.

Para chamar a PROCEDURE é utilizado um bloco PL/SQL anônimo. A procedure PUT_LINE imprime na tela o texto Número de linhas da tabela funcionario: e o conteúdo da variável num que recebeu o retorno do parâmetro p_total da PROCEDURE conta_funcionarios.

DECLARE
  num NUMBER;
BEGIN
  conta_funcionarios(num);
  DBMS_OUTPUT.PUT_LINE('Número de linhas da tabela funcionario:'||num);
END;
</pre>